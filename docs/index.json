[
{
	"uri": "https://efficienthacks.github.io/coderbook/dotnet/asyncawait/",
	"title": "async and await",
	"tags": ["csharp", "something"],
	"description": "",
	"content": " tldr async and await are keywords in C# to let code continue executing while waiting on a long operation (like downloading a file) to complete.\nTypically, I write synchronous code because it is easier to debug, after it works, then I\u0026rsquo;ll use async/await.\nTo make async methods synchronous (i.e. block further code execution until method finishes), add .Result to the end of the method call. E.g. client.DownloadFileAsync().Result\nQuick code snippet This is how you create a batch of web requests to run in parallel. (You await on Task.WhenAll() instead of awaiting after each call to DownloadWebsiteAsync())\npublic async Task RunDownloadParallelAsync() { List\u0026lt;string\u0026gt; websites = GetWebsiteList(); var tasks = new List\u0026lt;Task\u0026lt;DownloadWebsiteResult\u0026gt;\u0026gt;(); foreach (string site in websites) { tasks.Add(DownloadWebsiteAsync(site)); } List\u0026lt;DownloadWebsiteResult\u0026gt; results = await Task.WhenAll(tasks); foreach (DownloadWebsiteResult dwr in results) { ReportWebsiteInfo(dwr); } }   Code snippet is part of the example used in the following video.  Video This video does a great job at explaining async and await. Tim goes through the example of downloading a sequence of files. (Watch it in double speed):\n  Here\u0026rsquo;s how to cancel tasks and get progress on the task\n  "
},
{
	"uri": "https://efficienthacks.github.io/coderbook/dotnet/dynamictypes/",
	"title": "Ignoring Types",
	"tags": [],
	"description": "",
	"content": " Strongly typed vs dynamically typed Strongly typed means that the compiler will complain if a method does not exist in the class specified during variable declaration. C# is strongly typed, but if you are used to dynamically typed languages (like Python), you can do that too.\n//strongly typed Animal duck = Factory.MakeDuck(); duck.quack(); //compile error because quack() is not defined in Animal even though you know the underlying object is a duck  Dynamically typed means that the compiler will not care whether the method exists or not (it will be done at runtime)\n//dynamically typed dynamic duck = Factory.MakeDuck(); duck.quack(); //a method called \u0026quot;quack()\u0026quot; will be checked at runtime. Also, the autocomplete will not work for dynamic variables.  There may be cases where you will need to ignore the object type in order to make classes decoupled. It\u0026rsquo;s highly recommended that you have unit tests that will catch type errors.\nI typically use dynamic when parsing JSON data with arbitrary/unknown fields.\nTip: Type checking and casting in one line Here\u0026rsquo;s how you check whether an object is of a certain type\nif(someObject is Duck d) //shorthand for typecasting someObject to \u0026quot;Duck\u0026quot; within the if block { d.quack(); }  "
},
{
	"uri": "https://efficienthacks.github.io/coderbook/dotnet/reflection/",
	"title": "Reflection",
	"tags": [],
	"description": "",
	"content": " If you have scripting language that allows you to call C# (e.g. Powershell), or if you want to call undocumented private methods, then you need to learn how to use Reflection.\nWhat is \u0026ldquo;reflection\u0026rdquo;? It\u0026rsquo;s a way of programatically examining and calling code from an assembly (.dll/.exe) at runtime.\nThe examples here are in C#, but the concepts apply when you are using scripting languages that use .NET.\nLoad C# Objects How would you use classes from a different dll without importing it? You could use Assembly.UnsafeLoadFrom(\u0026quot;path to dll\u0026quot;); this will return an Assembly object, which you can use to create instances programatically.\nvar targetAssmbly = Assembly.UnsafeLoadFrom(@\u0026quot;\\\\pathTo\\your.dll\u0026quot;); var instance = targetAssmbly.CreateInstance(\u0026quot;Some.Class.In.Assembly\u0026quot;);  Create C# Objects (w/Reflection) Let\u0026rsquo;s start with two fundamental methods CreateInstance and GetType. These are instance methods in System.Reflection.Assembly.\nCreateInstance is equivalent to programatically making a new object.\n//this is the Reflection equivalent of doing var x = new System.Collections.ArrayList(); var x = \u0026quot;\u0026quot;.GetType().Assembly.CreateInstance(\u0026quot;System.Collections.ArrayList\u0026quot;);  GetType is equivalent to getting a handle to a class so that you can call a static method on it.\n//if you just want to call a static method //(such as System.Convert.FromBase64String) var convertType = \u0026quot;\u0026quot;.GetType().Assembly.GetType(\u0026quot;System.Convert\u0026quot;)  Notes Note that there is also a Type.GetType(string) static method that searches the current assembly for that Type. This can also be used.\nNote that you are only allowed to access classes from the same assembly as \u0026lsquo;String\u0026rsquo; (mscorlib.dll)\nInvoking [private] methods To invoke any method with parameters, you need to pass in the parameter list as an array of C# objects.\nBut in most scripting languages, there is no notion of a \u0026ldquo;type\u0026rdquo;. So how do you create a C# array of C# objects?\nAnswer: Use the ArrayList.Add(object) function to add objects of any type, then use the ArrayList.ToArray() to convert it to a C# array of objects.\nThere are two options that you can use to invoke methods. - with the method name: Type.GetMethod(\u0026quot;nameOfMethod\u0026quot;).Invoke(...) - get all the methods of the class, then select which one you want to invoke (by index): Type.GetMethods()[3].Invoke(...)\nQuestions you might have are: - how do you invoke a method on a class vs an instance?\n- how do you invoke async methods? - how do you invoke private methods?\nInvoking a static method on a class //Example of how to dynamically invoke 'System.Convert.FromBase64String()' \u0026quot;\u0026quot;.GetType().Assembly.GetType(\u0026quot;System.Convert\u0026quot;).GetMethod(\u0026quot;FromBase64String\u0026quot;).Invoke(null, new string[]{\u0026quot;base64 string\u0026quot;});  The first argument to Invoke is the object you want to target. In this case, we are not calling this method on an object, so it is null. The second argument to Invoke is the parameter list for the method FromBase64String. It must be passed as an Object[].\nInvoking an async method on an instance Here is another example of reflectively invoking a method on an instance of an object. Note the dynamic declaration of resultsToAwait.\nvar targetAssmbly = Assembly.UnsafeLoadFrom(@\u0026quot;\\\\pathTo\\your.dll\u0026quot;); var instance = targetAssmbly.CreateInstance(\u0026quot;Some.Class.In.Assembly\u0026quot;); dynamic resultsToAwait = targetAssmbly.GetType(\u0026quot;Some.Class.In.Assembly\u0026quot;).GetMethod(\u0026quot;GetStuffAsync\u0026quot;).Invoke(instance, null); //'null' because GetStuffAsync does not need parameters IEnumerable\u0026lt;dynamic\u0026gt; results = await resultsToAwait; //assuming that the results return an IEnumerable, you have to check the return type.  Invoking Methods By Index One reason for using this is if there are overloaded methods with the same number of parameters.\nFor example, Assembly.Load(AssemblyName) and Assembly.Load(byte[])\nThe first step is to list the methods - note that the methods can appear in a different order when you are running the code on a different machine.\nThis will list all the public methods of a given type.\nMethodInfo[] allMethods = \u0026quot;\u0026quot;.GetType().GetMethods();  Invoking Private Methods by index/name You need to use these objects called \u0026lsquo;BindingFlags\u0026rsquo; and use the method: GetMethods(BindingFlags.NonPublic | BindingFlags.Instance)\nvar privateMethods = \u0026quot;\u0026quot;.GetType() .GetMethods(BindingFlags.NonPublic | BindingFlags.Instance);  "
},
{
	"uri": "https://efficienthacks.github.io/coderbook/powershell/modules/",
	"title": "Creating Modules",
	"tags": [],
	"description": "",
	"content": " There are Script modules (.psm1 files) and Binary modules (aka cmdlets)\nScript Module A script module is essentially any valid PowerShell script saved in a .psm1 extension.\nfunction Show-Calendar { } Export-ModuleMember -Function Show-Calendar  The paths where you can install your module are located in the $env:PSModulePath global variable. Be sure to create a folder for your module to exist in, even if it is only a single .psm1 file\nBy default, all functions in your script are accessible to users who import your .psm1 file, but properties are not.\nBinary (C#) Module Make a class library (dll)\nYou have to import the module by dll name: Import-Module BinModuleTest\\PSbinModule.dll\nusing System.Management.Automation; // Windows PowerShell namespace. namespace ModuleCmdlets { [Cmdlet(VerbsDiagnostic.Test, \u0026quot;BinaryModuleCmdlet1\u0026quot;)] public class TestBinaryModuleCmdlet1Command : Cmdlet { protected override void BeginProcessing() { WriteObject(\u0026quot;BinaryModuleCmdlet1 exported by the ModuleCmdlets module.\u0026quot;); } } [Cmdlet(VerbsDiagnostic.Test, \u0026quot;BinaryModuleCmdlet2\u0026quot;)] public class TestBinaryModuleCmdlet2Command : Cmdlet { protected override void BeginProcessing() { WriteObject(\u0026quot;BinaryModuleCmdlet2 exported by the ModuleCmdlets module.\u0026quot;); } } [Cmdlet(VerbsDiagnostic.Test, \u0026quot;BinaryModuleCmdlet3\u0026quot;)] public class TestBinaryModuleCmdlet3Command : Cmdlet { protected override void BeginProcessing() { WriteObject(\u0026quot;BinaryModuleCmdlet3 exported by the ModuleCmdlets module.\u0026quot;); } } }  You invoke the cmdlet like this: \u0026ldquo;Test-BinaryModuleCmdlet1\u0026rdquo;\nDebugging Binary PS Modules If you\u0026rsquo;re using Visual Studio (and making a .NET Framework library), right click on the csproj and add this to the Debug command line args: -noexit -command \u0026quot;\u0026amp;{ import-module .\\[dllName].dll -verbose}\u0026quot;\nReference: https://www.powershellmagazine.com/2014/04/08/basics-of-writing-a-powershell-module-with-c-part-2-debugging/\nIf you are making a .NET Standard library, you\u0026rsquo;ll have to add a post build event: add dotnet publish --no-build to the post build event and change the command line argument to reference .\\publish\\[dllName].dll\nThe post build event copies all the dlls (in nuget packages) that you reference (like json.net) into the output folder.\nOriginal stackoverflow answer\n"
},
{
	"uri": "https://efficienthacks.github.io/coderbook/dotnet/decompiler/",
	"title": "Debugging with no source",
	"tags": [],
	"description": "",
	"content": " No Source? No Problem. Well-known decompilers are .NET Reflector, ILSpy. These will restore the source code from .NET dll or exe files (aka assemblies). You can even save the decompiled source as a csproj.\nOne step further A newer tool called \u0026ldquo;dnSpy\u0026rdquo; https://github.com/0xd4d/dnSpy lets you debug and edit .NET assemblies! (you can attach to a running process as well as launch)\nTo debug webapps running in IISExpress, you need to view the debug output from Visual Studio and find your dll in that list (because IISexpress copies the dlls to temp locations).\nFun fact: dnSpy uses the same engine as ILSpy to decompile\nHere it is in action:\n"
},
{
	"uri": "https://efficienthacks.github.io/coderbook/powershell/pipinginput/",
	"title": "Piping input",
	"tags": [],
	"description": "",
	"content": " So how do take input (which is usually an array of objects) that is passed to your module?\nPiping Input With PowerShell Module You just add an attribute to the parameter.\nfunction show-data { param( [Parameter(ValueFromPipeline=$true)] $InputObject ) begin { $objects = @() } process { $objects += $InputObject } end { foreach($obj in $objects) { $obj #$obj is written to the pipeline on each iteration of the loop } } } Get-ChildItem | show-data  Note that process is called for each item in the array being piped in. In the code snippet, we collected all the items to be processed during end\nUsing C# module In C# code, this is what it looks like:\nusing System.Management.Automation; //get this from nuget package manager - use PowerShellStandard.Library [Cmdlet(VerbsDiagnostic.Test, \u0026quot;PipelineObjDyn\u0026quot;)] public class TestPipelineDynamic : Cmdlet { [Parameter(ValueFromPipeline = true)] public dynamic ObjectFromPipeline { get; set; } //using dynamic because we don't know what type is going to be returned; using PSObject would be better. private List\u0026lt;dynamic\u0026gt; objects; protected override void BeginProcessing() { objects = new List\u0026lt;dynamic\u0026gt;(); } protected override void ProcessRecord() { objects.Add(ObjectFromPipeline); } protected override void EndProcessing() { foreach (var obj in objects) { WriteObject(obj); //writes object to the pipeline } } }  I strongly recommend using Visual Studio to set breakpoints and see what the underlying object (ObjectFromPipeline) looks like. You\u0026rsquo;ll get a much better understanding of what\u0026rsquo;s going on.\nCmdlet development tips When developing cmdlets (binary PS modules), you will want to convert PSObject to/from Dictionary\u0026lt;string,object\u0026gt; (or ExpandoObject)\npublic static class HelperExtensions { public static PSObject AsPSObject(this ExpandoObject eo) { //makes it so that your C# objects can be filtered/manipulated with powershell syntax var newpso = new PSObject(); var expandoAsDict = ((IDictionary\u0026lt;string, object\u0026gt;)eo); foreach (var k in expandoAsDict.Keys) { newpso.Members.Add(new PSNoteProperty(k, expandoAsDict[k])); } return newpso; } public static IDictionary\u0026lt;string,object\u0026gt; AsDictionary(this PSObject pso) { //makes stuff coming in from the pipeline easier to handle var newDict = new Dictionary\u0026lt;string, object\u0026gt;(); foreach (var prop in pso.Properties) { newDict[prop.Name] = prop.Value; } return newDict; } }  Example Cmdlet Code Example cmdlet that reads a csv file and outputs results as an array of PSObjects\n[Cmdlet(VerbsDiagnostic.Test, \u0026quot;WriteObject\u0026quot;)] public class TestBinaryModuleCmdlet1Command : Cmdlet { protected override void BeginProcessing() { using (var reader = new StreamReader(@\u0026quot;D:\\temp\\test.csv\u0026quot;)) { using (var csv = new CsvReader(reader)) { var records = csv.GetRecords\u0026lt;dynamic\u0026gt;(); foreach(var rec in records) { WriteObject(((ExpandoObject)rec).AsPSObject()); } } } } }  CsvReader is part of the CsvHelper nuget package\n"
},
{
	"uri": "https://efficienthacks.github.io/coderbook/dotnet/",
	"title": ".NET Intermediate Topics",
	"tags": [],
	"description": "",
	"content": " A guide to .NET for people who already know the basics FAQs .NET Standard vs .NET Core vs .NET Framework? Target .NET Core for executables that can be deployed on linux, mac + Windows.\nTarget .NET Framework if you\u0026rsquo;re in a Windows-only environment or need to use Windows-specific functionality (like the UI, or Active Directory)\nWhere possible, target .NET Standard for common code libraries (can be used by both .NET Core and Framework)\n"
},
{
	"uri": "https://efficienthacks.github.io/coderbook/powershell/",
	"title": "Powershell",
	"tags": [],
	"description": "",
	"content": " A guide to PowerShell for people who already know the basics FAQs PowerShell Core? Windows PowerShell? As of 2019, PowerShell Core (aka PowerShell 6) is missing a lot of features (especially for AD and Exchange management). It is a separate install and it\u0026rsquo;s named pwsh.exe. It uses .NET Core.\nWindows PowerShell is the original - found in C:\\WINDOWS\\System32\\WindowsPowerShell\\v1.0\\powershell.exe it comes with Windows and has version 1.0 to 5.1. It is using the .NET Framework.\nPowershell modules written in .NET Standard will work on both.\n"
},
{
	"uri": "https://efficienthacks.github.io/coderbook/web/",
	"title": "Web Apps",
	"tags": [],
	"description": "",
	"content": " A guide to Web Development in .NET (Make sure you take a look at the Azure Components section)\nFAQs What\u0026rsquo;s the general design of a web application? Currently, the \u0026lsquo;web application\u0026rsquo; component are just web APIs. Client front-ends (i.e. Angular, React, Progressive Web Apps, Mobile apps) will call the web app endpoints to retrieve data (typically in JSON format).\nThe web app (i.e. backend) interacts with databases and possibly other web services, while the client app (i.e. front end) displays that data in a meaningful way for the user.\nRegarding authentication, the back end provides a bearer token (usually in JWT format) that is stored in \u0026ldquo;local storage\u0026rdquo; in the browser/mobile application - traditionally, the user identifier were stored cookies.\n It\u0026rsquo;s 2019 when I\u0026rsquo;m writing this, so things might change.  ASP.NET Core and or Framework? Here\u0026rsquo;s the official documentation on that.\nhttps://docs.microsoft.com/en-us/dotnet/standard/choosing-core-framework-server\nBasically, use .NET Core if you\u0026rsquo;re starting a new csproj. It\u0026rsquo;s hard to just move from .NET Framework to Core.\nWhere possible, keep your code in libraries targeting .NET Standard. This is so that it can be reused in projects targeting either Core or Framework.\n"
},
{
	"uri": "https://efficienthacks.github.io/coderbook/azure/",
	"title": "Azure Basics",
	"tags": [],
	"description": "",
	"content": " A guide to the most frequently-used features in Azure FAQs Which Azure resources are the most important? Azure has a TON of \u0026ldquo;resources\u0026rdquo;, but you probably won\u0026rsquo;t use most of them. To get started, you\u0026rsquo;ll want to install the Azure CLI.\nThe most popular resources are: Storage account (which includes table, queue features as well), Key Vault and App Service (think of it as a shared VM that hosts your backend web applications).\nAzure also has VM resources if you need a cloud dev environment or want to deploy your web application with some custom database.\nApp services and VMs can be assigned a \u0026ldquo;managed service identity\u0026rdquo; (MSI), which is used behind the scenes so that you don\u0026rsquo;t have to authenticate to the storage account/key vault without having to deal with storing secrets.\n"
},
{
	"uri": "https://efficienthacks.github.io/coderbook/devops/",
	"title": "Devops (git/CI)",
	"tags": [],
	"description": "",
	"content": " What is Azure DevOps? This was the service formerly known as VSTS (renamed in 2018).\nIt\u0026rsquo;s a combination of services that support code development - each of the services have strange names though. Here\u0026rsquo;s what they mean:\n Boards = a Kanban board and a place where you track issues/work items sprints Repos = a git repository (can be public or private) Pipelines = a Continuous Integration tool - i.e. you check in the code and the tool does the build and deploy on some other server. You can have build scripts in PowerShell Artifacts = your own package feed (nuget, Maven, npm)  It can be installed either on your own server or used as a service (https://dev.azure.com).\n Disclaimer: I work at Microsoft (but not on the Azure Devops product). I would still recommend this service even if I didn\u0026rsquo;t.  How much? Pretty much free for 5 users or less.\nhttps://azure.microsoft.com/en-us/pricing/details/devops/azure-devops-services/\n"
},
{
	"uri": "https://efficienthacks.github.io/coderbook/08about/",
	"title": "About",
	"tags": [],
	"description": "",
	"content": " Why this site? I\u0026rsquo;ve created this site after reading a lot of bad documentation with so much fluff and thought to myself \u0026ldquo;Why can\u0026rsquo;t you just give me the damn code snippet?\u0026rdquo;\nSo I sought to create my own documentation site as I learn new technologies in the hopes that it would save you some time and frustration.\nwhoami My name is Ambrose and I love coding because it lets me create useful tools for others.\nI got started with computers by creating a website on GeoCities. My latest project aside from this site is a web application I built that helps you listen to your selection of web articles on your smartphone - My Orator.\nBesides computer stuff, I am a student of traditional Shaolin Kung Fu.\nHere\u0026rsquo;s how you can reach me (apologies in advance, I\u0026rsquo;m slow to respond):    /  \n"
},
{
	"uri": "https://efficienthacks.github.io/coderbook/devops/git/",
	"title": "Git (cmd line)",
	"tags": [],
	"description": "",
	"content": " Initiate a Git repo from a folder with contents Say you already have a code project going in a folder and want to version control it in Git, here\u0026rsquo;s how you do it:\ngit init git remote add origin [git URL] git add . git commit -m \u0026quot;[commit message]\u0026quot; git push --set-upstream origin master  Git (with submodules) Submodules are essentially a reference to another Git repo. You may want to break up a modular component and track it in its own repo.\nBy default, when you clone a git repo, it will not copy the submodules.\nClone a git repo with submodules git clone [git URL] --recursive or --recurse-submodules\nGrab submodules if you forget to recursively clone This also updates the submodules to point to their latest branch HEAD.\ngit submodule update --remote --recursive\nAdd a submodule git submodule add [URL of submodule]\nOther useful commands git status  More Reading This article includes a section that covers how to make a folder in your repo into a submodule.\nhttps://github.blog/2016-02-01-working-with-submodules/\n"
},
{
	"uri": "https://efficienthacks.github.io/coderbook/azure/keyvault/",
	"title": "Keyvault",
	"tags": [],
	"description": "",
	"content": " Why use a KeyVault? To keep creds out of source control. (even if it\u0026rsquo;s just creds for dev/test)\nEven if you don\u0026rsquo;t use keyvault, you should use environment variables to keep your secrets into being checked into git. The Keyvault API uses different mechanisms to access the keyvault - i.e. no code changes required if running locally or running in production.\nThe code Here\u0026rsquo;s how to do it quickly in a Console application (works the same way when you do it for a web application - sample web app project available in \u0026lsquo;Further Reading\u0026rsquo; section):\nusing Microsoft.Azure.KeyVault; using Microsoft.Azure.Services.AppAuthentication; static void Main(string[] args) { string secretstr,error ; var azureServiceTokenProvider = new AzureServiceTokenProvider(); //details: by default, it uses VS creds, Azure CLI, then Azure AD (if running on a domain joined machine) - whatever works first - I ran into an issue where I wanted to run it under a different cred than VS and it took me a while to figure out how to get it to just use Azure CLI creds. If you have different creds that you use in Visual Studio, pass in this parameter :\u0026quot;RunAs=Developer; DeveloperTool=AzureCli\u0026quot; try { var callback = new KeyVaultClient.AuthenticationCallback(azureServiceTokenProvider.KeyVaultTokenCallback); //this is where the magic happens (it tries multiple ways to authentication) var keyVaultClient = new KeyVaultClient(callback); var secrets = keyVaultClient.GetSecretsAsync(\u0026quot;https://testvault123.vault.azure.net/\u0026quot;).Result; //get all secrets var secret = keyVaultClient.GetSecretAsync(\u0026quot;https://testvault123.vault.azure.net/secrets/ambroseSecret\u0026quot;).Result; //get secret called 'ambroseSecret' secretstr = $\u0026quot;Secret: {secret.Value}\u0026quot;; } catch (Exception exp) { error = $\u0026quot;Something went wrong: {exp.Message}\u0026quot;; } var principal = azureServiceTokenProvider.PrincipalUsed != null ? $\u0026quot;Principal Used: {azureServiceTokenProvider.PrincipalUsed}\u0026quot; : string.Empty; } //set a breakpoint here to inspect the variables  How does it work? It works by using your local creds when in development and using a \u0026ldquo;managed identity\u0026rdquo;. When you run your code on an Azure App Service or an Azure VM with a managed identity enabled, the library automatically uses the managed identity. You might have to go to the Azure portal to enable managed identity.\nHere\u0026rsquo;s how you enable managed identity on from the Azure portal - (as of 2019): Further Reading The official documentation:\nhttps://docs.microsoft.com/en-us/azure/key-vault/service-to-service-authentication\nTry it out with a sample web application:\nhttps://github.com/Azure-Samples/app-service-msi-keyvault-dotnet\n"
},
{
	"uri": "https://efficienthacks.github.io/coderbook/web/authn/",
	"title": "Authentication (with tokens)",
	"tags": [],
	"description": "",
	"content": " The basics of \u0026ldquo;Sign in with _____\u0026rdquo; First, make the user log in via an authentication provider (e.g. Google, Azure AD, Microsoft account)\nThe authn provider will send the user\u0026rsquo;s token to your website (the reply URL you specify)\nFrom your website, you take this token (which typically includes the user\u0026rsquo;s email and name) and verify it using another endpoint provided by the authn provider.\nSign in using a Microsoft Account (console application) You actually don\u0026rsquo;t need a web application to make use of OAuth. According to this answer, you can use a special client ID and reply URL to obtain a JWT (which includes the user\u0026rsquo;s name and email address).\nBecause this is a console app and you want to use OAuth for authentication, you have to create a project that targets .NET Framework. The reason is that it pops up a browser window (which is tied to .NET Framework) to have the user (who is at the command line) authenticate to Microsoft. This is done in the PromptForAuthn method.\nBecause this token is submitted to you by the user, you have to take this token and send it to https://login.microsoftonline.com/... and to verify the token\u0026rsquo;s signature. Which is what the Validate method does.\nusing Microsoft.IdentityModel.Clients.ActiveDirectory; using Microsoft.IdentityModel.Protocols; using Microsoft.IdentityModel.Protocols.OpenIdConnect; using Microsoft.IdentityModel.Tokens; using System; using System.Collections.Generic; using System.IdentityModel.Tokens.Jwt; using System.Linq; using System.Net.Http.Headers; using System.Text; using System.Threading.Tasks; namespace GettingAADToken { class Program { static void Main(string[] args) { var token = PromptForAuthn(); var x = Validate(token.Parameter); var name = x.Claims.Where(y =\u0026gt; y.Type == \u0026quot;upn\u0026quot;).First().Value; } static string requestedResource = \u0026quot;499b84ac-1321-427f-aa17-267ca6975798\u0026quot;; //azure devops static string clientId = \u0026quot;872cd9fa-d31f-45e0-9eab-6e460a02d1f1\u0026quot;; //visual studio static string tenantId = \u0026quot;72f988bf-86f1-41af-91ab-2d7cd011db47\u0026quot;; // Microsoft tenant's ID public static AuthenticationHeaderValue PromptForAuthn() { AuthenticationContext ctx = GetAuthenticationContext(tenantId); AuthenticationResult result = null; IPlatformParameters promptBehavior = new PlatformParameters(PromptBehavior.Auto); try { result = ctx.AcquireTokenAsync(requestedResource, clientId, new Uri(\u0026quot;urn:ietf:wg:oauth:2.0:oob\u0026quot;), promptBehavior).Result; Console.WriteLine(\u0026quot;Token expires on: \u0026quot; + result.ExpiresOn); var bearerAuthHeader = new AuthenticationHeaderValue(\u0026quot;Bearer\u0026quot;, result.AccessToken); return bearerAuthHeader; } catch (UnauthorizedAccessException) { // If the token has expired, prompt the user with a login prompt result = ctx.AcquireTokenAsync(requestedResource, \u0026quot;872cd9fa-d31f-45e0-9eab-6e460a02d1f1\u0026quot;, new Uri(\u0026quot;urn:ietf:wg:oauth:2.0:oob\u0026quot;), promptBehavior).Result; } catch (Exception ex) { Console.WriteLine(\u0026quot;{0}: {1}\u0026quot;, ex.GetType(), ex.Message); } return null; } private static AuthenticationContext GetAuthenticationContext(string tenant) { AuthenticationContext ctx = null; if (tenant != null) ctx = new AuthenticationContext(\u0026quot;https://login.microsoftonline.com/\u0026quot; + tenant); else { ctx = new AuthenticationContext(\u0026quot;https://login.windows.net/common\u0026quot;); if (ctx.TokenCache.Count \u0026gt; 0) { string homeTenant = ctx.TokenCache.ReadItems().First().TenantId; ctx = new AuthenticationContext(\u0026quot;https://login.microsoftonline.com/\u0026quot; + homeTenant); } } return ctx; } public static JwtSecurityToken Validate(string token) { string stsDiscoveryEndpoint = \u0026quot;https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration\u0026quot;; ConfigurationManager\u0026lt;OpenIdConnectConfiguration\u0026gt; configManager = new ConfigurationManager\u0026lt;OpenIdConnectConfiguration\u0026gt;(stsDiscoveryEndpoint, new OpenIdConnectConfigurationRetriever()); OpenIdConnectConfiguration config = configManager.GetConfigurationAsync().Result; TokenValidationParameters validationParameters = new TokenValidationParameters { ValidateAudience = true, ValidateIssuer = true, IssuerSigningKeys = config.SigningKeys, ValidateLifetime = true }; validationParameters.ValidAudience = requestedResource; validationParameters.ValidIssuer = $\u0026quot;https://sts.windows.net/{tenantId}/\u0026quot;; JwtSecurityTokenHandler tokendHandler = new JwtSecurityTokenHandler(); SecurityToken jwt; var result = tokendHandler.ValidateToken(token, validationParameters, out jwt); return jwt as JwtSecurityToken; } } }  Making your web application generate OAuth tokens (from scratch) This is a .NET Core 2.1 example. You can start from a blank Web API project.\nStep 1: Add a secret string\nThis will be used to generate and verify the bearer token. I\u0026rsquo;ll be providing code to read the token from an environment variable so you don\u0026rsquo;t check secrets into git.\nappsettings.json\n{ \u0026quot;Logging\u0026quot;: { ... }, \u0026quot;AppSettings\u0026quot;: { \u0026quot;Token\u0026quot;: \u0026quot;myTokenEnvVar\u0026quot; } }  Step 2: Add token generation logic to your authentication logic\nMake a new controller called AuthnController with the following method. Of course, this won\u0026rsquo;t work yet because you need to set up some configuration. But go ahead and try it anyways and see what happens.\nusing System; using System.Collections.Generic; using System.IdentityModel.Tokens.Jwt; using System.Linq; using System.Security.Claims; using System.Text; using System.Threading.Tasks; using Microsoft.AspNetCore.Authorization; using Microsoft.AspNetCore.Mvc; using Microsoft.Extensions.Configuration; using Microsoft.IdentityModel.Tokens; ... private readonly IConfiguration _config; public AuthnController(IConfiguration config) { _config = config; } [HttpPost(\u0026quot;login\u0026quot;)] public IActionResult Login([FromBody] UserPassModel up) { if(IsUserValid(up.Username, up.Password)) //this would be some backend database check { return Unauthorized(); } var tokenHandler = new JwtSecurityTokenHandler(); //read the key from the environment variable var key = Encoding.ASCII.GetBytes( System.Environment.GetEnvironmentVariable( _config.GetSection(\u0026quot;AppSettings:Token\u0026quot;).Value, EnvironmentVariableTarget.User ) ); var tokenDescriptor = new SecurityTokenDescriptor { Issuer = \u0026quot;self\u0026quot;, //in our scenario, Issuer and Audience won't be verified, only the key will Audience = \u0026quot;aud\u0026quot;, Subject = new System.Security.Claims.ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Email, \u0026quot;emailAddressHere\u0026quot;), new Claim(ClaimTypes.Name, up.Username) //you can have as few or as many claims here }), Expires = DateTime.UtcNow.AddDays(10), SigningCredentials = new SigningCredentials( new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature) }; var token = tokenHandler.CreateToken(tokenDescriptor); var tokenString = tokenHandler.WriteToken(token); return Ok(tokenString); }  Step 3: Add Configuration code to Startup.cs\npublic void ConfigureServices(IServiceCollection services) { services.AddMvc(); var key = Encoding.ASCII.GetBytes( System.Environment.GetEnvironmentVariable( Configuration.GetSection(\u0026quot;AppSettings:Token\u0026quot;).Value, EnvironmentVariableTarget.User ) ); services.AddAuthentication(Microsoft.AspNetCore.Authentication.JwtBearer.JwtBearerDefaults.AuthenticationScheme) .AddJwtBearer(options =\u0026gt; { options.IncludeErrorDetails = true; options.TokenValidationParameters = new Microsoft.IdentityModel.Tokens.TokenValidationParameters { ValidateIssuerSigningKey = true, IssuerSigningKey = new Microsoft.IdentityModel.Tokens.SymmetricSecurityKey(key), ValidIssuer = \u0026quot;self\u0026quot;, ValidateIssuer = true, ValidateAudience = false }; }); }  Step 4: Add code to the Configure() method in the same file\nThis one is easily missed. You have to add app.UseAuthentication() and this has to be before app.UseMvc()\npublic void Configure(IApplicationBuilder app, IHostingEnvironment env) { if (env.IsDevelopment()) { app.UseDeveloperExceptionPage(); } app.UseAuthentication(); //\u0026lt;-- this is important app.UseMvc(); }  Step 5: Profit\nFinally, you need a method that requires authentication to test this out.\nYou need to add the [Authorize] attribute to the controller.\n[Authorize] [Route(\u0026quot;api/[controller]\u0026quot;)] public class RequiresAuthnController : Controller { [HttpGet(\u0026quot;getuser/{id}\u0026quot;)] public IActionResult GetUser(int id) { return Ok(\u0026quot;user here \u0026quot; + id + User.Identity.Name); }  Here\u0026rsquo;s what it looks like in Postman\n[todo: add snippet to sign in with Google/Microsoft account for a web application]\n"
},
{
	"uri": "https://efficienthacks.github.io/coderbook/tags/",
	"title": "Tags",
	"tags": [],
	"description": "",
	"content": ""
},
{
	"uri": "https://efficienthacks.github.io/coderbook/tags/csharp/",
	"title": "csharp",
	"tags": [],
	"description": "",
	"content": ""
},
{
	"uri": "https://efficienthacks.github.io/coderbook/tags/something/",
	"title": "something",
	"tags": [],
	"description": "",
	"content": ""
},
{
	"uri": "https://efficienthacks.github.io/coderbook/",
	"title": "",
	"tags": [],
	"description": "",
	"content": " Quick usage docs for .NET coders \nless explanations, more code examples. \nHello! If you\u0026rsquo;re a developer who knows the basics and want to know how to use some new API/feature as quickly as possible, you\u0026rsquo;re in the right place.\n"
},
{
	"uri": "https://efficienthacks.github.io/coderbook/categories/",
	"title": "Categories",
	"tags": [],
	"description": "",
	"content": ""
}]